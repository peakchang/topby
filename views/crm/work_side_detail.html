{% include "crm/db_head.html" %}


<style>
    .dropBox {
        height: 7rem;
        margin-bottom: 0.75rem;
        border-radius: 0.75rem;
        border: 2px dashed;
        border-color: #4374D9;
    }

    .dropactive {
        opacity: 0.7;
        border: 2px solid;
        border-color: #6799FF;
    }

    .dropdown {
        height: auto;
        border: 2px solid;
        border-color: #6799FF;
    }

    /* .imge_list{
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
    } */
    /* .imge_list img{
        width: 25%;
        max-width: 150px;
        border: 1px solid #BDBDBD;
        border-radius: 0.75rem;
    } */
</style>

<body>
    <div class="container w-11/12 mt-2 rounded-md text-sm suit-font text-center">
        <form method="post" enctype="multipart/form-data">
            <table class="border-collapse border border-slate-400 w-full  rounded">
                <input type="hidden" name="hy_num" value="{{ get_hy_info.hy_num }}">
                <tr>
                    <th class="border bg-slate-100 border-slate-300 py-1 text-center">현장명</th>
                    <td class="border border-slate-300 py-1 text-center">
                        <input type="text"
                            class="block p-2 w-4/5 text-gray-900 bg-gray-50 rounded-lg border border-gray-300 sm:text-xs mx-auto"
                            name="hy_title" placeholder="">
                    </td>
                </tr>




                <tr>
                    <th class="border bg-slate-100 border-slate-300 py-1 text-center">간략설명</th>
                    <td class="border border-slate-300 py-1 text-center">
                        <textarea name="hy_description" id="" rows="3"
                            class="text-gray-900 bg-gray-50 rounded-lg border border-gray-300 w-4/5"></textarea>
                    </td>
                </tr>
                <tr>
                    <th class="border bg-slate-100 border-slate-300 py-1 text-center">키워드</th>
                    <td class="border border-slate-300 py-1 text-center">
                        <input type="text"
                            class="block p-2 w-4/5 text-gray-900 bg-gray-50 rounded-lg border border-gray-300 sm:text-xs mx-auto"
                            name="hy_keywords" placeholder="">
                    </td>
                </tr>
                <tr>
                    <th class="border bg-slate-100 border-slate-300 py-1 text-center">사이트명</th>
                    <td class="border border-slate-300 py-1 text-center">
                        <input type="text"
                            class="block p-2 w-4/5 text-gray-900 bg-gray-50 rounded-lg border border-gray-300 sm:text-xs mx-auto"
                            name="hy_site_name" placeholder="">
                    </td>
                </tr>
                <tr>
                    <th class="border bg-slate-100 border-slate-300 py-1 text-center">사업명</th>
                    <td class="border border-slate-300 py-1 text-center">
                        <input type="text"
                            class="block p-2 w-4/5 text-gray-900 bg-gray-50 rounded-lg border border-gray-300 sm:text-xs mx-auto"
                            name="hy_businessname" placeholder="">
                    </td>
                </tr>
                <tr>
                    <th class="border bg-slate-100 border-slate-300 py-1 text-center">분류</th>
                    <td class="border border-slate-300 py-1 text-center">
                        <input type="text"
                            class="block p-2 w-4/5 text-gray-900 bg-gray-50 rounded-lg border border-gray-300 sm:text-xs mx-auto"
                            name="hy_type" placeholder="">
                    </td>
                </tr>
                <tr>
                    <th class="border bg-slate-100 border-slate-300 py-1 text-center">규모</th>
                    <td class="border border-slate-300 py-1 text-center">
                        <input type="text"
                            class="block p-2 w-4/5 text-gray-900 bg-gray-50 rounded-lg border border-gray-300 sm:text-xs mx-auto"
                            name="hy_scale" placeholder="">
                    </td>
                </tr>
                <tr>
                    <th class="border bg-slate-100 border-slate-300 py-1 text-center">전용면적</th>
                    <td class="border border-slate-300 py-1 text-center">
                        <input type="text"
                            class="block p-2 w-4/5 text-gray-900 bg-gray-50 rounded-lg border border-gray-300 sm:text-xs mx-auto"
                            name="hy_areasize" placeholder="">
                    </td>
                </tr>
                <tr>
                    <th class="border bg-slate-100 border-slate-300 py-1 text-center">세대수</th>
                    <td class="border border-slate-300 py-1 text-center">
                        <input type="text"
                            class="block p-2 w-4/5 text-gray-900 bg-gray-50 rounded-lg border border-gray-300 sm:text-xs mx-auto"
                            name="hy_house_number" placeholder="">
                    </td>
                </tr>
                <tr>
                    <th class="border bg-slate-100 border-slate-300 py-1 text-center">공급위치</th>
                    <td class="border border-slate-300 py-1 text-center">
                        <input type="text"
                            class="block p-2 w-4/5 text-gray-900 bg-gray-50 rounded-lg border border-gray-300 sm:text-xs mx-auto"
                            name="hy_location" placeholder="">
                    </td>
                </tr>
                <tr>
                    <th class="border bg-slate-100 border-slate-300 py-1 text-center">입주예정</th>
                    <td class="border border-slate-300 py-1 text-center">
                        <input type="text"
                            class="block p-2 w-4/5 text-gray-900 bg-gray-50 rounded-lg border border-gray-300 sm:text-xs mx-auto"
                            name="hy_scheduled" placeholder="">
                    </td>
                </tr>
                <tr>
                    <th class="border bg-slate-100 border-slate-300 py-1 text-center">시공사</th>
                    <td class="border border-slate-300 py-1 text-center">
                        <input type="text"
                            class="block p-2 w-4/5 text-gray-900 bg-gray-50 rounded-lg border border-gray-300 sm:text-xs mx-auto"
                            name="hy_builder" placeholder="">
                    </td>
                </tr>
                <tr>
                    <th class="border bg-slate-100 border-slate-300 py-1 text-center">시행사</th>
                    <td class="border border-slate-300 py-1 text-center">
                        <input type="text"
                            class="block p-2 w-4/5 text-gray-900 bg-gray-50 rounded-lg border border-gray-300 sm:text-xs mx-auto"
                            name="hy_conduct" placeholder="">
                    </td>
                </tr>
                <tr>
                    <th class="border bg-slate-100 border-slate-300 py-1 text-center">특장점</th>
                    <td class="border border-slate-300 py-1 text-center">
                        <textarea name="hy_features" id="" rows="3"
                            class="text-gray-900 bg-gray-50 rounded-lg border border-gray-300 w-4/5"></textarea>
                    </td>
                </tr>

                <tr>
                    <th class="border bg-slate-100 border-slate-300 py-1 text-center">전화번호</th>
                    <td class="border border-slate-300 py-1 text-center">

                        <input type="text"
                            class="block p-2 w-4/5 text-gray-900 bg-gray-50 rounded-lg border border-gray-300 sm:text-xs mx-auto"
                            name="hy_conduct" placeholder="">
                        <span>※ 미입력시 기본 대표번호로 등록됩니다.</span>
                    </td>
                </tr>

                <tr>
                    <th class="border bg-slate-100 border-slate-300 py-1 text-center">메인이미지</th>
                    <td class="border border-slate-300 py-1 text-center">
                        <input name="main_img"
                            class="form-control block w-2/4 py-1.5 mx-auto text-base font-normal text-gray-700 bg-white bg-clip-padding border border-solid border-gray-300 rounded transition ease-in-out m-0 focus:text-gray-700 focus:bg-white focus:border-blue-600 focus:outline-none"
                            type="file" id="formFile">

                        <div class="text-center max-w-xs mx-auto mt-4">
                            <img src="" alt="" class="mx-auto preview_main_image">
                        </div>

                    </td>
                </tr>
            </table>

            <div class="mt-3 text-center">
                <input type="hidden" name="hy_image_list" value="{{get_hy_info.hy_image_list}}">
                <div class="text-xl">이미지 리스트</div>



                {% if get_hy_info.hy_image_list %}
                <div class="dropBox dropdown">
                    {% else %}
                    <div class="dropBox">
                        {% endif %}

                        {% if get_hy_info.hy_image_list %}

                        {% else %}
                        <div class="flex flex-col justify-center items-center h-full">
                            <span class="text-xl">이미지를 드래그해주세요</span>
                            <span class="text-4xl text-neutral-500"><i class="fa fa-plus-circle"
                                    aria-hidden="true"></i></span>
                        </div>
                        {% endif %}


                        <div class="grid grid-cols-4 gap-1 p-1 imge_list">
                            {% for hy_image in get_hy_info.hy_image_arr %}
                            <div class="border border-gray-500 rounded-lg overflow-hidden relative drag_items">
                                <span class="absolute top-1 right-1 text-2xl text-red-500 text-center del_img"><i
                                        class="fa fa-times-circle"></i></span>
                                <div class="h-full flex items-center">
                                    <img src="/img/{{get_hy_info.hy_num}}/{{hy_image}}" alt="">
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <div>
                            <span class="">추가하실 이미지를 드래그해주세요</span>
                            <span class=" text-neutral-500"><i class="fa fa-plus-circle" aria-hidden="true"></i></span>
                        </div>

                    </div>
                </div>


                <button class="border rounded-lg py-2 text-white bg-cyan-700 text-xl w-3/5 mb-7">등록하기</button>
        </form>
    </div>
</body>

<script>
    $('.testget').click(function (e) {
        console.log('aslidjfliasjdfljaf');
    })


    $(document).on('click','.del_img',function (e) {
        console.log('lskdjlksjfljsdlkfjsf');
        const hy_num = document.querySelector('input[name=hy_num]').value
        var imgList = document.querySelector('input[name=hy_image_list]').value.split(',');
        const getDelIndex = $(this.parentNode).index();
        const getDelTargetImg = imgList[getDelIndex]
        imgList.splice(getDelIndex, 1)
        const getUpdateImgList = imgList.join(',');
        document.querySelector('input[name=hy_image_list]').value = getUpdateImgList;
        $(this.parentNode).remove()
        $.ajax({
            url: '/crm/del_image',
            // dataType: 'json',
            // async: false,
            method: 'POST',
            data: { hy_num, getDelTargetImg, getUpdateImgList },
            success: function (data) {
                console.log('succedd!!!');
                location.reload()
            }, error: function () {
                console.log('failed!!!');
            }
        });





    })

    const $drop = document.querySelector(".dropBox");
    const dragItems = $('.drag_items')
    console.log(dragItems);
    // 드래그한 파일 객체가 해당 영역에 놓였을 때

    $('.dragItems').on({
        'dragstart' : function(e) {
            console.log('dlsjflsjdfljsdf');            
        }
    })
    $drop.ondrop = (e) => {
        e.preventDefault();
        console.log(this);
        console.log(e);
        console.log(e.target);
        const preFileList = document.querySelector('input[name=hy_image_list]').value.split(',');
        

        $drop.className = "dropBox";

        // 파일 리스트
        const files = [...e.dataTransfer?.files];

        const formData = new FormData();
        var fileList = []

        var check = /[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/;
        for (let i = 0; i < files.length; i++) {
            if (check.test(files[i].name)) {
                alert('파일명에 한글이 포함되어 있으면 안됩니다! 영어/숫자로 변경해주세요!')
                return false
            }else {
                fileList.push(files[i].name)
            }
        }
        // else if(preFileList.includes(files[i].name)){
        //         alert('중복되는 파일이 있습니다! 확인해주세요!')
        //         location.reload()
        //         return false
        //     } 
        const fileListStr = fileList.join(',');
        formData.append('fileListStr', fileListStr);
        formData.append('hy_num', document.querySelector('input[name=hy_num]').value);

        for (let i = 0; i < files.length; i++) formData.append('testimg', files[i]);

        $.ajax({
            url: '/crm/arr_image',
            dataType: 'json',
            // async: false,
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            beforeSend: function () {
                console.log('로딩중입니다~~~~~~~~~~~~~~~~~~~~~~');
            }, success: function (data) {
                $('.imge_list').empty()
                console.log(data.SetHyImgList);
                for (let i = 0; i < data.SetHyImgList.length; i++) {
                    const template = `<div class="border border-gray-500 rounded-lg overflow-hidden relative">
                            <span class="absolute top-1 right-1 text-2xl text-red-500 text-center"><i
                                    class="fa fa-times-circle"></i></span>
                            <div class="h-full flex items-center">
                            <img src="/img/${document.querySelector('input[name=hy_num]').value}/${data.SetHyImgList[i]}" alt="">
                            </div>
                        </div>`
                    $('.imge_list').append(template)
                }
                location.reload()

                // const SetImgListStr = data.SetHyImgList.join(',');
                // document.querySelector('input[name=hy_image_list]').value = SetImgListStr
            }, error: function () {
                console.log('failed!!!');
            }
        });
        $drop.classList.add("dropdown");
    }

    // ondragover 이벤트가 없으면 onDrop 이벤트가 실핻되지 않습니다.
    $drop.ondragover = (e) => {
        e.preventDefault();
        console.log('꺄~~~~~~~~~~~~~~~~~~~~~~~~~~~');
        $drop.classList.add("dropactive");
    }

    // 드래그한 파일이 최초로 진입했을 때
    $drop.ondragenter = (e) => {
        e.preventDefault();
        console.log('진입~~~!!!!!!!!!!!!!');
        // $drop.classList.add("active");
    }

    // 드래그한 파일이 영역을 벗어났을 때
    $drop.ondragleave = (e) => {
        e.preventDefault();
        console.log('빠져나감~~~~~~~~~~~');
        $drop.classList.remove("dropactive");
    }





    $('#formFile').change(function (e) {
        console.log('sldjflsjdflisjdf');
        const previewImage = document.querySelector('.preview_main_image')
        readImage(e.target, previewImage)
    })

    function readImage(input, previewImage) {
        // 인풋 태그에 파일이 있는 경우
        if (input.files && input.files[0]) {
            // 이미지 파일인지 검사 (생략)
            // FileReader 인스턴스 생성
            const reader = new FileReader()
            // 이미지가 로드가 된 경우
            reader.onload = e => {
                console.log(e.target.result);
                previewImage.src = e.target.result
            }
            // reader가 이미지 읽도록 하기
            reader.readAsDataURL(input.files[0])
        }
    }

</script>